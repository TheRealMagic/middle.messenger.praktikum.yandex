class e{constructor(e,t,s){this._pathname=e,this._controllerClass=t,this._controller=null,this._props=s}navigate(e){this.match(e)&&this.render()}leave(){this._controller&&this._controller.hideView()}match(e){return t=e,s=this._pathname,t===s;var t,s}render(){this._controller||(this._controller=new this._controllerClass(this._props)),function(e,t){const s=document.querySelector(e);s&&(s.innerHTML="",s.appendChild(t.getContent()))}(this._props.rootQuery,this._controller.view)}}function t(e,t,s){const n=t.split(".");let i=e;for(let e of n)if(i=i[e],void 0===i)return s;return i??s}function s(e){return"object"==typeof e&&e&&!Array.isArray(e)}var n=function e(t,n){return Object.keys(n).reduce(((t,i)=>{const a=t[i],o=n[i];return i in t&&s(a)&&s(o)?e(a,o):(t[i]=n[i],t)}),t),t};var i=function(e,t,s){if("object"!=typeof e||null===e||Array.isArray(e))return e;!function(e){if("string"!=typeof e)throw new Error("path must be string")}(t);const i=function(e,t){if(~e.indexOf(","))throw new Error("Нет точек");const s=e.split(".");return s.reduceRight(((e,n,i)=>i===s.length-1&&void 0!==t?{[n]:t}:{[n]:e}),{})}(t,s);return n(e,i)};class a{constructor(){this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){if(!this.listeners[e])throw new Error(`Нет события: ${e}`);this.listeners[e]=this.listeners[e].filter((e=>e!==t))}emit(e,...t){if(!this.listeners[e])throw new Error(`Нет события: ${e}`);this.listeners[e].forEach((e=>{e(...t)}))}}let o;!function(e){e.Updated="updated"}(o||(o={}));var r=new class extends a{set(e,t){i(this.state,e,t),this.emit(o.Updated,e,t)}getState(){return this.state}constructor(...e){super(...e),this.state={}}};class c{constructor(e){if(c.__instance)return c.__instance;this.routes=[],this.history=window.history,this._currentRoute=null,this._rootQuery=e,c.__instance=this}use(t,s){const n=new e(t,s,{rootQuery:this._rootQuery});return this.routes.push(n),this}start(){window.addEventListener("popstate",(e=>{this._onRoute(e.currentTarget.location.pathname)}));let e=t(r.getState(),"user");const s=window.location.pathname;!e||"/"!==s&&"/sign-up"!==s?this._onRoute(window.location.pathname):this.go("/messenger")}_onRoute(e){const t=this.getRoute(e);this._currentRoute=t,t?t.render():this.go("/404")}go(e){this.history.pushState({},"",e),this._onRoute(e)}back(){this.history.back()}forward(){this.history.forward()}getRoute(e){return this.routes.find((t=>t.match(e)))}}class l{constructor(e){this.view=e,this.eventBus=new a}hideView(){this.view.hide()}showView(){this.view.show()}}const h=/\{\{(.*?)\}\}/gi,u={id:"id",classes:"class",style:"style",placeholder:"placeholder",type:"type",value:"value",href:"href",name:"name",alt:"alt",src:"src"};class p{constructor(e){this._template="",this.items=[],this.classes=[],this.textContent="",this._template=e}_compileTemplate(e){let s=this._template,n=null;const i=[];for(;n=h.exec(s);)if(n[1]){const s=n[1].trim().split(" ").filter((e=>e));let a=s.pop();for(;a;){const n=t(e,a);if(n){if(this._isBlock(n)){this.items.push(n.getContent()),a=s.pop();continue}if(this._isBlockArray(n)){n.forEach((e=>{this.items.push(e.getContent())})),a=s.pop();continue}{let e="";if(this._isStringArray(n))if("classes"===a)this.classes=n,e=`${u[a]}='${n.join(" ")}'`;else{const t=n.join("");e=u[a]?`${u[a]}='${t}'`:t}else{if("textContent"===a){this.textContent=n,a=s.pop();continue}"false"!==n&&(e=u[a]?`${u[a]}='${n}'`:n)}i.push(e)}}a=s.pop()}}return s=s.replace(h,i.join(" ")),this._getElement(s)}_getElement(e){const t=document.createElement("template");let s;return t.innerHTML=e,s=this.classes.length?t.content.querySelector(`.${this.classes.join(".")}`):t.content.children[0],s&&(s.textContent=this.textContent,this.items.forEach((e=>s.appendChild(e)))),s}_isBlock(e){return e instanceof d}_isStringArray(e){return Array.isArray(e)&&e.every((e=>"string"==typeof e))}_isBlockArray(e){return Array.isArray(e)&&e.every((e=>e instanceof d))}compile(e){return this._compileTemplate(e)}}class d{constructor(e="div",t,s){this.template="",this.setProps=e=>{e&&Object.assign(this.props,e)},this.template=s,this._meta={tagName:e,props:t},this.props=this._makePropsProxy(t),this.eventBus=new a,this._registerEvents(this.eventBus),this.eventBus.emit(d.EVENTS.INIT)}_registerEvents(e){e.on(d.EVENTS.INIT,this.init.bind(this)),e.on(d.EVENTS.FLOW_CDM,this._componentDidMount.bind(this)),e.on(d.EVENTS.FLOW_CDU,this._componentDidUpdate.bind(this)),e.on(d.EVENTS.FLOW_RENDER,this._render.bind(this))}init(){this._createResources(),this.eventBus.emit(d.EVENTS.FLOW_CDM)}_componentDidMount(){this.componentDidMount(),this.eventBus.emit(d.EVENTS.FLOW_RENDER)}_createResources(){const{tagName:e}=this._meta;this._element=this._createDocumentElement(e)}_createDocumentElement(e){return document.createElement(e)}componentDidMount(){}dispatchComponentDidMount(){this.eventBus.emit(d.EVENTS.FLOW_CDM)}componentDidUpdate(e,t){return e!==t}_componentDidUpdate(e,t){this.componentDidUpdate(e,t)&&this.eventBus.emit(d.EVENTS.FLOW_RENDER)}get element(){return this._element}_render(){const e=this.render();this.removeListeners();const t=this._element;this._element=e,t.replaceWith(e),this.addListeners()}render(){return new p(this.template||"").compile(this.props)}getContent(){return this.element}_makePropsProxy(e){const t=this;return new Proxy(e||{},{get:(e,t,s)=>Reflect.get(e,t,s),set:(e,s,n,i)=>{if(e[s]!==n){const a=e[s];Reflect.set(e,s,n,i),t.eventBus.emit(d.EVENTS.FLOW_CDU,a,n)}return!0},deleteProperty(){throw new Error("нет доступа")}})}addListeners(){const e=this.props.listeners;e&&this.element&&Object.entries(e).forEach((([e,t])=>{this.element.addEventListener(e,t,{once:"blur"===e})}))}removeListeners(){const e=this.props.listeners;e&&this.element&&Object.entries(e).forEach((([e,t])=>{this.element.removeEventListener(e,t)}))}toggleClasses(e,t){const s=new Set(this.props.classes);return s.size&&(t.forEach((e=>s.delete(e))),e.forEach((e=>s.add(e)))),Array.from(s)}show(){this._element.style.display="block"}hide(){this._element.style.display="none"}}d.EVENTS={INIT:"init",FLOW_CDM:"flow:component-did-mount",FLOW_CDU:"flow:component-did-update",FLOW_RENDER:"flow:render"};class m extends d{constructor(e){super("div",e,"<div {{ classes textContent }}></div>")}}class g extends d{constructor(e,t){super("div",e,t||"<div {{ classes textContent form label }}></div>")}}class v extends d{constructor(e){super("input",e,"<input {{ name type placeholder value classes disabled }}></input>")}validate(){return this.props.validator?(this.props.validator.field=this.getContent(),this.props.validator.checkValid()):""}}class C extends d{constructor(e){const t=new m({classes:e.labelClasses||[],textContent:e.placeholder||"Поле"});e.alwaysShowlabel||t.hide();const s=new v(e),n=new m({classes:["base-label","warning-label",...e.warningLabelClasses||[]],textContent:""});n.hide(),super("div",{classes:["input-container",...e.containerClasses||[]],fieldNameLabel:t,inputField:s,validationLabel:n},"<div {{ classes validationLabel inputField fieldNameLabel}}></div>"),this.alwaysShowlabel=e.alwaysShowlabel,this.neverShowlabel=e.neverShowlabel,this.fieldNameLabel=t;const i=Object.assign(e.listeners||{},{focus:()=>{s.focused=!0,this.checkHideLabel(),this.validate()},blur:e=>{s.setProps({value:e.target.value}),s.focused=!1,this.checkHideLabel(),this.validate()}});s.setProps({listeners:i}),this.inputField=s,this.validationLabel=n}componentDidUpdate(e,t){return this.inputField&&this.inputField.setProps({value:this.props.value}),e!==t}render(){const e=new p("<div {{ classes validationLabel inputField fieldNameLabel}}></div>").compile(this.props);return this.checkHideLabel(),e}checkHideLabel(){this.alwaysShowlabel||this.neverShowlabel||!this.fieldNameLabel||(this.input.props.value||this.input.focused?this.fieldNameLabel.show():this.fieldNameLabel.hide())}validate(){const e=this.input.validate();return e?(this.validationLabel.setProps({textContent:e}),this.validationLabel.show()):(this.validationLabel.setProps({textContent:""}),this.validationLabel.hide()),e}addListeners(){this.input&&this.input.addListeners()}removeListeners(){this.input&&this.input.removeListeners()}get input(){return this.inputField}}class b extends d{constructor(e,t){super("form",e,t)}validate(){const e=Object.values(this.props).filter((e=>e instanceof v||e instanceof C));let t=!1;for(let s=0;s<e.length;s++)t=!!e[s].validate()||t;return t}}class w{constructor(e){(e=e||[]).push({text:"Заполните поле",fn:e=>!!e}),this.validFncs=e}checkValid(){if(this.field)for(let e=0;e<this.validFncs.length;e++){const t=this.validFncs[e];if(!t.fn(this.field.value))return t.text}}}class f extends w{constructor(){const e=[];e.push({text:"Первая буква должна быть заглавной",fn:e=>!e||e[0]===e[0].toLocaleUpperCase()}),e.push({text:"Есть пробелы и/или цифры",fn:e=>!/[\d\s]/.test(e)}),e.push({text:"Есть недопустимые символы",fn:e=>!/["'&<>_]/.test(e)}),super(e)}}class _ extends w{constructor(){const e=[];e.push({text:"Длина от 8 до 40 символов",fn:e=>e.length>=8&&e.length<=40}),e.push({text:"Неверный формат пароля (большая буква)",fn:e=>/[A-ZА-ЯЁ]/.test(e)}),e.push({text:"Неверный формат пароля (digit)",fn:e=>/\d/.test(e)}),super(e)}}class E extends w{constructor(){const e=[];e.push({text:"Нет букв",fn:e=>/\w+/.test(e)}),e.push({text:"От 3 до 20 символов",fn:e=>e.length>=3&&e.length<=20}),e.push({text:"Только латинница",fn:e=>!/[а-яёА-ЯЁ]/.test(e)}),e.push({text:"Есть спецсимволы или пробел",fn:e=>!/["'&<>\s]/.test(e)}),super(e)}}class A extends w{constructor(){const e=[];e.push({text:"Длина от 10 до 15 символов",fn:e=>e.length>=10&&e.length<=15}),e.push({text:"Неверный формат телефона",fn:e=>!/\++\d+/.test(e)}),super(e)}}class S extends w{constructor(){const e=[];e.push({text:"Только латинница",fn:e=>!/[а-яёА-ЯЁ]/.test(e)}),e.push({text:"Неверный формат email",fn:e=>/[\w\d]+@\w+\.\w+/.test(e)}),super(e)}}class k{static getValidator(e){return(e=e.toLowerCase()).includes("name")?new f:e.includes("password")?new _:e.includes("login")?new E:e.includes("phone")?new A:e.includes("email")?new S:new w}}class x extends b{constructor(e){const t=new C({name:"login",type:"text",placeholder:"Логин",classes:["base-input","base-input-text","sign-text-input"],containerClasses:["sign-input-container"],labelClasses:["base-label","login-label"],validator:k.getValidator("login")}),s=new C({name:"password",type:"password",placeholder:"Пароль",classes:["base-input","base-input-text","sign-text-input"],containerClasses:["sign-input-container"],labelClasses:["base-label","login-label"],validator:k.getValidator("password")});super({classes:["base-form","sign-form","login-form"],actionContainer:new g({classes:["login-form__action-container","sign-action-container"],link:e.link,btn:e.btn},"<div {{ classes link btn }}></div>"),passInput:s,nameInput:t,listeners:e.listeners},"<form {{ classes actionContainer passInput nameInput}} ></form>")}}class y extends d{constructor(e){const t=e.popupContainer,s=document.querySelector("body");s&&(s.style.overflow="hidden"),super("div",{classes:["body-mask"],popupContainer:t,listeners:{click:()=>{this.hide()}}},"<div {{ classes popupContainer }}></div>"),this.popupContainer=t}get container(){return this.popupContainer}show(){const e=document.querySelector("body");e&&(e.style.overflow="hidden"),function(e){const t=document.querySelector("body");t&&t.appendChild(e.getContent())}(this)}hide(){const e=document.querySelector("body");e&&(e.style.overflow="visible"),this.getContent().remove()}}class L extends d{constructor(){const e=new m({classes:["form-header"],textContent:"Вход"}),t=new d("a",{classes:["base-link","sign-link"],href:"/",textContent:"Нет аккаунта?"},"<a {{ classes textContent href }}></a>"),s=new v({type:"submit",value:"Авторизоваться",listeners:{click:function(){}},classes:["base-input","base-input-button","sign-btn","action-container__autorize-btn"]}),n=new x({link:t,btn:s});super("div",{mainBlock:new g({classes:["login-block","main-block"],label:e,form:n})},"<div {{ classes mainBlock form }} ></div>"),n.setProps({listeners:{submit:this.onLoginSubmit.bind(this)}}),t.setProps({listeners:this.getLinkListener()}),this.form=n,this.eventBus.on("loginError",(e=>this.onLoginError(e)))}getLinkListener(){return{click:e=>{e.preventDefault();new c("body").go("/sign-up")}}}onLoginSubmit(e){e.preventDefault();const t=e.target,s={login:t.login.value,password:t.password.value};this.form.validate()||this.eventBus.emit("formSubmit",s)}onLoginError(e){const t=new m({textContent:e}),s=new v({value:"OK",classes:["popup-btn","base-input-button","sign-btn"],listeners:{click:()=>{i.hide()}}}),n=new g({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0}},loginErrorLabel:t,loginErrorBtn:s},"<div {{ classes textContent loginErrorBtn loginErrorLabel }}></div>"),i=new y({popupContainer:n});i.show()}}class B{create(){throw new Error("Not implemented")}request(){throw new Error("Not implemented")}update(){throw new Error("Not implemented")}delete(){throw new Error("Not implemented")}}function T(e){return"object"==typeof e&&null!==e&&e.constructor===Object&&"[object Object]"===Object.prototype.toString.call(e)}function D(e){return T(e)||function(e){return Array.isArray(e)}(e)}function P(e,t){return t?`${t}[${e}]`:e}function N(e,t){const s=[];for(const[n,i]of Object.entries(e))D(i)?s.push(...N(i,P(n,t))):s.push([P(n,t),encodeURIComponent(String(i))]);return s}function U(e){if(!T(e))throw new Error("input must be an object");return N(e).map((e=>e.join("="))).join("&")}let M;var F;(F=M||(M={})).GET="GET",F.POST="POST",F.PUT="PUT",F.DELETE="DELETE";class I{constructor(e){this.get=(e,t={})=>(t.data&&Object.keys(t.data).length&&(e+=U(t.data),delete t.data),this.request(e,{...t,method:M.GET},t.timeout)),this.put=(e,t={})=>this.request(e,{...t,method:M.PUT},t.timeout),this.post=(e,t={})=>this.request(e,{...t,method:M.POST},t.timeout),this.delete=(e,t={})=>this.request(e,{...t,method:M.DELETE},t.timeout),this.request=(e,t,s=5e3)=>new Promise(((n,i)=>{const{method:a,data:o,headers:r,form:c}=t,l=new XMLHttpRequest;l.open(t.method,this.baseUrl+e),r&&Object.entries(r).forEach((([e,t])=>{l.setRequestHeader(e,t)})),"include"===t.credentials&&(l.withCredentials=!0),l.onload=function(){n(l)};const h=()=>{i(new Error("Ошибка запроса"))};l.onabort=h,l.onerror=h,l.ontimeout=h,c?l.send(c):a!==M.GET&&o?l.send(JSON.stringify(o)):l.send(),setTimeout((()=>{i(new Error("timeout"))}),s)})),this.baseUrl=e||""}}const O=new I("https://ya-praktikum.tech/api/v2/");class H extends B{static getUser(){return O.get("auth/user",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"}}).then((e=>{let t=null;200===e.status&&(t=JSON.parse(e.responseText)),r.set("user",t)}))}static logout(){return O.post("auth/logout",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"}}).then((()=>{r.set("user",null)}))}}const R=new I("https://ya-praktikum.tech/api/v2/");const j=new class extends B{login(e){return R.post("auth/signin",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:e}).then((e=>{200===e.status&&H.getUser()}))}};class V extends l{constructor(){super(new L),this.currentState="login",this.view.eventBus.on("formSubmit",(e=>this.onFormSubmit(e))),r.on(o.Updated,((e,t)=>this.onApplicationStoreUpdate(e,t)))}onApplicationStoreUpdate(e,t){"user"===e&&t&&t.id&&this.onChangeUser(),"loginError"===e&&this.view.eventBus.emit("loginError",t)}onChangeUser(){new c("body").go("/messenger")}onFormSubmit(e){try{j.login(e)}catch(e){r.set("loginError",e)}}}class G extends d{constructor(){const e=r.getState(),s=new g({classes:["back-btn-container__back-btn"],textContent:"❮",listeners:{click:()=>{new c("body").go("/messenger")}}}),n=new g({classes:["back-btn-container"],backButton:s},"<div {{ classes backButton }}></div>"),i=new m({textContent:"Загрузите файл"}),a=new v({textContent:"Выбрать файл на компьютере",type:"file",name:"avatar",classes:["popup-link"],listeners:{click:e=>{e.cancelBubble=!0}}}),o=new v({value:"Изменить аватар",type:"submit",classes:["popup-button","base-input-button","sign-btn"],listeners:{click:e=>{e.cancelBubble=!0}}}),l=new b({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0},submit:e=>{e.cancelBubble=!0,e.preventDefault();let t=new FormData(e.target);t.get("avatar").size&&this.eventBus.emit(Q.CHANGE_AVATAR,t)}},changeAvatarTitle:i,changeAvatarLink:a,changeAvatarButton:o},"<form {{ classes changeAvatarButton changeAvatarLink changeAvatarTitle }}></form>"),h=new d("img",{classes:["avatar"]},"<img {{ classes src }}></img>"),u=t(e,"user.avatar");u&&h.setProps({src:"https://ya-praktikum.tech/api/v2"+u});const p=new g({classes:["new-avatar"],textContent:"Изменить аватар",listeners:{click:()=>{new y({popupContainer:l}).show()}}}),C=new g({classes:["avatar-wrapper"],img:h,newAvatar:p},"<div {{ classes newAvatar img }}></div>"),w=t(e,"user.display_name"),f=new g({classes:["name-label"],textContent:w||""}),{form:_,items:E}=W(!1),A=new g({classes:["content-wrapper"],avatarWrapper:C,nameLabel:f,profileForm:_},"<div {{ classes profileForm changePassForm nameLabel avatarWrapper }}></div>");super("div",{classes:["page-wrapper"],backBtnContainer:n,profileContainer:new g({classes:["profile-container"],contentWrapper:A},"<div {{ classes contentWrapper }}></div>")},"<div {{ classes profileContainer backBtnContainer }}></div>"),this.profileFormItems=E,this.contentWrapper=A;const S=this.getActionContainer(this.getPreviewActionContainerItems());_.setProps({listeners:{submit:function(e){const t=Array.prototype.reduce.call(e.target.elements,((e,{name:t,value:s})=>(t&&s&&(e[t]=s),e)),{});if(!_.validate()){this.eventBus.emit(Q.CHANGE_DATA,t);const e=this.getActionContainer(this.getPreviewActionContainerItems());this.setInputsDisable(!0),this.profileForm.setProps({actionsContainer:e})}e.preventDefault()}.bind(this)}}),this.profileForm=_,this.profileForm.setProps({actionsContainer:S}),this.avatarImg=h,this.submit()}submit(){r.on(o.Updated,((e,t)=>this.onChangeUserData(e,t)))}onChangeUserData(e,t){if("user"===e&&t?.id){const{form:e,items:s}=W(!1);this.profileFormItems=s,this.profileForm=e,this.contentWrapper.setProps({form:this.profileForm}),this.contentWrapper.props.nameLabel.setProps({textContent:t.display_name||""}),this.avatarImg.setProps({src:"https://ya-praktikum.tech/api/v2"+t.avatar})}}getActionContainer(e){return new g({classes:["profile-form__action-container","profile-action-container"],...e},"<div {{ classes exitButton changePassButton changeDataButton saveDataButton   }}></div>")}getPreviewActionContainerItems(){return{changeDataButton:this.getProfileActionButton("Изменить данные",["main-profile-btn","action-container__change-data-btn"],"button",this.onChangeDataClick),changePassButton:this.getProfileActionButton("Изменить пароль",["main-profile-btn","action-container__change-password-btn"],"button",this.onChangePassButtonClick),exitButton:this.getProfileActionButton("Выйти",["main-profile-btn","action-container__exit-btn"],"button",(()=>{this.eventBus.emit(Q.LOGOUT)}))}}getChangeDataActionsContainer(){return{saveDataButton:this.getProfileActionButton("Сохранить",["sign-btn","action-container__save-data-btn"],"submit")}}getChangePassActionsContainer(){return{saveDataButton:this.getProfileActionButton("Сохранить",["sign-btn","action-container__save-data-btn"],"submit")}}onChangeDataClick(){this.eventBus.emit(Q.CHANGE_STATE,J.ChangeInfo),this.setInputsDisable(!1);const e=this.getActionContainer(this.getChangeDataActionsContainer());this.profileForm.setProps({actionsContainer:e})}onChangePassButtonClick(){if(this.eventBus.emit(Q.CHANGE_STATE,J.ChangePass),!this.changePassForm){const{form:e}=function(){const e=$("oldPassword","password","Старый пароль",!0),t=$("newPassword","password","Новый пароль",!0),s=$("newPasswordConf","password","Повторите пароль",!0);return{form:new b({classes:["profile-form","base-form"],oldPass:e,newPass:t,newPassConfirmation:s},"<form {{ classes actionsContainer newPassConfirmation newPass oldPass }}></form>"),items:{oldPass:e,newPass:t,newPassConfirmation:s}}}();e.setProps({actionsContainer:this.getActionContainer(this.getChangePassActionsContainer()),listeners:{submit:function(t){const s=Array.prototype.reduce.call(t.target.elements,((e,{name:t,value:s})=>(t&&s&&(e[t]=s),e)),{});e.validate()||(this.eventBus.emit(Q.CHANGE_PASSWORD,s),this.changePassForm.hide(),this.profileForm.show()),t.preventDefault()}.bind(this)}}),this.changePassForm=e,this.contentWrapper.setProps({changePassForm:this.changePassForm})}this.profileForm.hide(),this.changePassForm.show()}setInputsDisable(e){this.profileFormItems&&Object.values(this.profileFormItems).forEach((t=>t.input.setProps({disabled:e?"disabled":"false"})))}getProfileActionButton(e,t=[],s="button",n){let i={type:s,value:e,classes:["base-input-button","base-input",...t]};return n&&(i=Object.assign(i,{listeners:{click:n.bind(this)}})),new v(i)}}function W(e){const{user:t}=r.getState(),s=$("email","string","Почта",e,t.email),n=$("login","string","Логин",e,t.login),i=$("first_name","string","Имя",e,t.first_name),a=$("second_name","string","Фамилия",e,t.second_name),o=$("display_name","string","Имя в чате",e,t.display_name),c=$("phone","string","Телефон",e,t.phone);return{form:new b({classes:["profile-form","base-form"],email:s,login:n,firstName:i,secondName:a,displayName:o,phone:c},"<form {{ classes actionsContainer phone displayName secondName firstName login email }}></form>"),items:{email:s,login:n,firstName:i,secondName:a,displayName:o,phone:c}}}function $(e,t,s,n=!0,i=""){let a;const o={containerClasses:["input-container","profile-input-container"],labelClasses:["profile-input-label"],warningLabelClasses:["profile-warning-label"],alwaysShowlabel:!0,name:e,type:t,placeholder:s,classes:["profile-text-input","base-input","base-input-text"],validator:k.getValidator(e)};return i&&Object.assign(o,{value:i}),n||Object.assign(o,{disabled:"disabled"}),a=new C(o),a}const q=new I("https://ya-praktikum.tech/api/v2/");let J,Q;!function(e){e.Preview="preview",e.ChangeInfo="changeInfo",e.ChangePass="changePass"}(J||(J={})),function(e){e.CHANGE_STATE="changeState",e.CHANGE_DATA="changeData",e.CHANGE_PASSWORD="changePassword",e.CHANGE_AVATAR="changeAvatar",e.LOGOUT="logout"}(Q||(Q={}));const z=new class extends B{changeData(e){return q.put("user/profile",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:e}).then((e=>{200===e.status&&H.getUser()}))}changhePassword(e){return q.put("user/password",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:e})}changeAvatar(e){return q.put("user/profile/avatar",{credentials:"include",mode:"cors",form:e})}};class K extends l{constructor(){super(new G),this.currentState=J.Preview,this.submit()}submit(){this.view.eventBus.on(Q.CHANGE_STATE,(e=>this.setState(e))),this.view.eventBus.on(Q.CHANGE_DATA,(e=>this.changeUserData(e))),this.view.eventBus.on(Q.CHANGE_PASSWORD,(e=>this.changeUserPassword(e))),this.view.eventBus.on(Q.CHANGE_AVATAR,(e=>this.changeAvatar(e))),this.view.eventBus.on(Q.LOGOUT,(()=>H.logout()))}setState(e){this.currentState=e}changeUserData(e){z.changeData(e),this.setState(J.Preview)}changeUserPassword(e){z.changhePassword(e),this.setState(J.Preview)}changeAvatar(e){z.changeAvatar(e)}get state(){return this.currentState}}class X extends d{constructor(e){const t=new g({classes:["chat-item__image-container"]},"<div {{ classes image }}></div>"),s=new m({textContent:e.title,classes:["chat-item__name-label"]}),n=r.getState().user.login===e.last_message?.user.login;let i="<Нет сообщений>";e.last_message?.content&&(i=(n?"Вы: ":"")+e.last_message?.content);const a=new m({textContent:i,classes:["chat-item__last-message-label"]}),o=new g({classes:["chat-item__center-container"],chatNameLabel:s,chatLastMessageLabel:a},"<div {{ classes chatLastMessageLabel isMine chatNameLabel }}></div>"),c=new m({classes:["chat-item__last-message-time-label"]});if(e.last_message?.time){const t=new Date(Date.parse(e.last_message?.time)).toLocaleDateString();c.setProps({textContent:t})}else c.hide();const l=new m({classes:["chat-item__new-message-label"],textContent:e.unread_count});e.unread_count||l.hide();const h=new g({classes:["chat-item__right-container"],newMessageCountLabel:l,lastMessageTimeLabel:c},"<div {{ classes newMessageCountLabel lastMessageTimeLabel }}></div>");super("div",{classes:["chat-item"],marker:`data-chat-id='${e.id||"0"}'`,imageContainer:t,centerContainer:o,rightContainer:h},"<div {{ classes rightContainer centerContainer imageContainer marker }}></div>"),this.chatLastMessageLabel=a,this.lastMessageTimeLabel=c,this.newMessageCountLabel=l,this.id=e.id,this.title=e.chatName,this.eventBus.on("newMessage",this.handleNewMessageEvent)}handleNewMessageEvent(e,t,s,n){n?this.chatLastMessageLabel.props.isMine.show():this.chatLastMessageLabel.props.isMine.hide(),this.chatLastMessageLabel.setProps({textContent:e}),this.lastMessageTimeLabel.setProps({textContent:t}),s?(this.newMessageCountLabel.setProps({textContent:""+s}),this.newMessageCountLabel.show()):this.newMessageCountLabel.hide()}}class Z extends d{constructor(){const e=new d("a",{classes:["left-container__profile-link","base-link"],href:"#",textContent:"Профиль ❯",listeners:{click:e=>{e.preventDefault();new c("body").go("/settings")}}},"<a {{ classes textContent href }}></a>"),t=new v({classes:["left-container__search","left-container__search_empty","base-input","base-input-text"],placeholder:"🔎 Поиск"}),s=new g({classes:["chat-list-action-button","add-chat-button"],textContent:"Добавить чат"}),n=new g({classes:["chat-list-action-button","delete-chat-button"],textContent:"Удалить чат"}),i=new g({classes:["chat-list-action-button","add-chat-button"],textContent:"Добавить пользователя в чат"}),a=new g({classes:["chat-list-action-button","delete-chat-button"],textContent:"Удалить пользователя из чата"}),o=new g({classes:["chat-list-container"],textContent:"Загрузка чатов..."},"<div {{ classes textContent chats }}></div>"),r=new g({classes:["left-container"],chatListContainer:o,chatSearchField:t,deleteChatButton:n,addChatButton:s,addUserButton:i,deleteUserButton:a,profileLink:e},"<div {{ classes chatListContainer chatSearchField deleteUserButton addUserButton deleteChatButton addChatButton profileLink }}></div>"),l=new g({classes:["chat-container__empty"],textContent:"Выберите чат чтобы отправить сообщение"},"<div {{ classes textContent sendForm chatMessagesContainer }}></div>");super("div",{classes:["page-wrapper"],leftContainer:r,chatContainer:l},"<div {{ classes chatContainer leftContainer }}></div>"),o.setProps({listeners:{click:this.onChatItemClick.bind(this)}}),this.chatListContainer=o,this.chatContainer=l,this.submit(),t.setProps({listeners:{keyup:this.searchChats.bind(this)}}),this.search=t,s.setProps({listeners:{click:()=>this.eventBus.emit(te.ADD_CHAT)}}),n.setProps({listeners:{click:()=>this.eventBus.emit(te.DELETE_CHAT,this.activeChatId)}}),i.setProps({listeners:{click:()=>this.eventBus.emit(te.ADD_CHAT_USER,this.activeChatId)}}),a.setProps({listeners:{click:()=>this.eventBus.emit(te.DELETE_CHAT_USER,this.activeChatId)}}),n.hide(),i.hide(),a.hide(),this.deleteChatButton=n,this.addUserButton=i,this.deleteUserButton=a,this.deleteUserButton=a}submit(){this.eventBus.on(te.ON_CHAT_ACTIVATED,this.onChatActivated.bind(this)),this.eventBus.on(te.REFRESH_CHATS,(e=>this.refreshChatList(e))),this.eventBus.on(te.ON_CHAT_DESELECTED,(()=>this.onChatDeselected())),this.eventBus.on(te.RECEIVE_MESSAGE,(e=>{const s=e.map((e=>({isMine:t(r.getState(),"user.id")===e.user_id,message:e.content})));this.addMessageHandler(s)}))}refreshChatList(e){if(e.length){const t=this.search.props.value;t&&(e=e.filter((e=>e.title.includes(t))));const s=e.map((e=>new X(e)));this.chatListContainer.setProps({chats:s,textContent:""})}else this.chatListContainer.setProps({textContent:"Нет чатов",chats:[]})}onChatDeselected(){this.chatContainer.element.classList.remove("chat-container"),this.chatContainer.setProps({classes:["chat-container__empty"],textContent:"Выберите чат чтобы отправить сообщение",chatMessagesContainer:null,sendForm:null}),this.deleteChatButton.hide(),this.addUserButton.hide(),this.deleteUserButton.hide()}searchChats(e){if("Enter"===e.code){const t=e.target.value||"";this.eventBus.emit("chatSearchFieldChanged",t)}}onChatItemClick(e){const t=e.target.closest(".chat-item");if(t&&Number(t.dataset.chatId)!==this.activeChatId){const e=this.element.querySelector(".chat-item__active");e&&e.classList.remove("chat-item__active"),t.classList.add("chat-item__active");const s=t.dataset.chatId;this.eventBus.emit("chatActivated",s)}}onChatActivated(e=""+this.activeChatId||""){if(!this.sendForm){const t=new m({classes:["send-item","send-button"],textContent:"+"}),s=new v({classes:["send-item","send-message"],type:"text",name:"message",placeholder:"Введите сообщение"}),n=new v({classes:["send-item","send-button"],type:"submit",value:"➜"}),i=new b({classes:["send-message-form"],attachButton:t,message:s,sendMessageButton:n,listeners:{submit:this.onSendFormSubmit.bind(this)}},"<form {{ classes sendMessageButton message attachButton }}></form>");this.sendForm=i,this.chatMessagesContainer=this.getChatMessagesContainer(Number(e))}this.activeChatId=Number.parseInt(e),this.deleteChatButton.show(),this.addUserButton.show(),this.deleteUserButton.show(),this.chatContainer.setProps({classes:["chat-container"],textContent:"",sendForm:this.sendForm,chatMessagesContainer:this.chatMessagesContainer})}getChatMessagesContainer(e){return new g({chatId:e,classes:["chat-messages-container"]},"<div {{ classes messages }}></div>")}getMessages(){return this.chatMessagesContainer.props.chatId===this.activeChatId&&this.chatMessagesContainer.props.messages||[]}getChatItem(e){const t=["chat-message-item-span"];return e.isMine&&t.push("my-message"),new g({classes:["chat-message-item"],messageSpan:new g({textContent:e.message,classes:t},"<span {{ classes textContent }}></span>")},"<div {{ classes messageSpan }}></div>")}onSendFormSubmit(e){e.preventDefault();const t=e.target.message.value;t&&(e.target.message.value="",this.eventBus.emit(te.SEND_MESSAGE,this.activeChatId,t))}addMessageHandler(e){const t=this.getMessages();for(let s=e.length-1;s>=0;s--)t.push(this.getChatItem(e[s]));this.chatMessagesContainer=this.getChatMessagesContainer(this.activeChatId),this.chatMessagesContainer.setProps({messages:t}),this.chatContainer.setProps({chatMessagesContainer:this.chatMessagesContainer})}}const Y=new I("https://ya-praktikum.tech/api/v2/");const ee=new class extends B{getChats(){return Y.get("chats",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"}}).then((e=>{r.set("chats",JSON.parse(e.responseText))}))}createChat(e){return Y.post("chats",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:{title:e}}).then((()=>{this.getChats()}))}deleteChat(e){Y.delete("chats",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:{chatId:e}}).then((()=>{this.getChats()}))}addChatUsers(e){Y.put("chats/users",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:{...e}}).then((()=>{this.getChats()}))}deleteChatUsers(e){Y.delete("chats/users",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:{...e}}).then((()=>{this.getChats()}))}getChatToken(e){Y.post("chats/token/"+e,{credentials:"include",mode:"cors",headers:{"content-type":"application/json"}}).then((t=>{r.set(`tokens.${e}`,JSON.parse(t.responseText))}))}getNewMessagesCount(e){Y.get("chats/new/"+e,{credentials:"include",mode:"cors",headers:{"content-type":"application/json"}}).then((e=>{r.set("activeChatNewMessagesCount",JSON.parse(e.responseText))}))}};let te;!function(e){e.GET_CHATS="getChats",e.REFRESH_CHATS="refreshChatList",e.ADD_CHAT="addChatClick",e.DELETE_CHAT="deleteChatClick",e.ON_CHAT_DESELECTED="onChatChatDeselected",e.ON_CHAT_ACTIVATED="chatActivated",e.ADD_CHAT_USER="addChatUser",e.DELETE_CHAT_USER="deleteChatUser",e.SEND_MESSAGE="sendMessage",e.RECEIVE_MESSAGE="receiveMessage"}(te||(te={}));class se extends l{constructor(){super(new Z),this.sockets={},this.subscribe(),this.publish()}subscribe(){r.on(o.Updated,((e,t)=>this.onApplicationStoreUpdate(e,t))),this.view.eventBus.on(te.GET_CHATS,(()=>this.getChats())),this.view.eventBus.on(te.ON_CHAT_ACTIVATED,(e=>this.onChatActivated(e))),this.view.eventBus.on(te.ADD_CHAT,(()=>this.onAddChatClick())),this.view.eventBus.on(te.DELETE_CHAT,(e=>this.onDeleteChatClick(e))),this.view.eventBus.on(te.ADD_CHAT_USER,(e=>this.showUserActionPopup(e,!1))),this.view.eventBus.on(te.DELETE_CHAT_USER,(e=>this.showUserActionPopup(e,!0))),this.view.eventBus.on(te.SEND_MESSAGE,((e,t)=>this.sendMessage(e,t)))}publish(){this.view.eventBus.emit(te.GET_CHATS)}getChats(){ee.getChats()}sendMessage(e,t){const s=this.sockets[e];s&&s.send(JSON.stringify({content:t,type:"message"}))}onApplicationStoreUpdate(e,t){"chats"===e&&this.onChatsUpdated(t),/tokens.*/.test(e)&&this.onTokensChanged(t),"activeChatNewMessagesCount"===e&&this.onNewMessagesCountCHanged()}onNewMessagesCountCHanged(){const e=this.view.activeChatId;this.sockets[e].send(JSON.stringify({content:"0",type:"get old"}))}onChatsUpdated(e){this.view.eventBus.emit(te.REFRESH_CHATS,e)}onTokensChanged(e){const t=e.token;if(!t)return;const s=this.view.activeChatId;this.sockets[s]?ee.getNewMessagesCount(s):this.createSocket(s,t)}createSocket(e,s){if(!e)return;const n=t(r.getState(),"user.id");if(!n)return;const i=`wss://ya-praktikum.tech/ws/chats/${n}/${e}/${s}`,a=this.sockets[e]=new WebSocket(i);this.applySocketListeners(a,e)}applySocketListeners(e,t){e.addEventListener("open",(()=>{ee.getNewMessagesCount(t),console.log("Соединение установлено "+t)})),e.addEventListener("close",(e=>{e.wasClean?console.log("Соединение закрыто чисто"):console.log("Обрыв соединения"),console.log(t+` Код: ${e.code} | Причина: ${e.reason}`),delete this.sockets[t]})),e.addEventListener("message",(e=>{const t=JSON.parse(e.data);Array.isArray(t)&&this.view.eventBus.emit(te.RECEIVE_MESSAGE,t),"message"===t.type&&this.view.eventBus.emit(te.RECEIVE_MESSAGE,[t])})),e.addEventListener("error",(e=>{console.log("Ошибка",e.message)})),setInterval((()=>{e.send(JSON.stringify({type:"ping"}))}),6e4)}onReceiveMessage(e){this.view.eventBus.emit(te.RECEIVE_MESSAGE,e)}onAddChatClick(){const e=new v({classes:["base-input","base-input-text","sign-text-input"],placeholder:"Название чата"}),t=new v({value:"Создать",classes:["popup-btn","base-input-button","sign-btn"],listeners:{click:t=>{t.cancelBubble=!0,t.preventDefault();const s=e.element.value;s&&(ee.createChat(s),this.view.eventBus.emit(te.ON_CHAT_DESELECTED)),n.hide()}}}),s=new g({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0}},input:e,button:t},"<div {{ classes button input }}></div>"),n=new y({popupContainer:s});n.show()}onDeleteChatClick(e){const t=new m({textContent:"Вы уверены что хотите удалить чат?"}),s=new v({value:"Удалить",classes:["popup-btn","base-input-button","sign-btn"],listeners:{click:t=>{t.cancelBubble=!0,t.preventDefault(),i.hide(),ee.deleteChat(e),this.view.eventBus.emit(te.ON_CHAT_DESELECTED)}}}),n=new g({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0}},label:t,button:s},"<div {{ classes button label }}></div>"),i=new y({popupContainer:n});i.show()}showUserActionPopup(e,t){const s=new v({classes:["base-input","base-input-text","sign-text-input"],placeholder:"Id пользователей"}),n=new v({value:t?"Удалить":"Добавить",classes:["popup-btn","base-input-button","sign-btn"],listeners:{click:n=>{n.cancelBubble=!0,n.preventDefault();const i=s.element.value;if(i){const s={users:i.split(",").map((e=>Number.parseInt(e))),chatId:e};t?ee.deleteChatUsers(s):ee.addChatUsers(s)}a.hide()}}}),i=new g({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0}},input:s,button:n},"<div {{ classes button input }}></div>"),a=new y({popupContainer:i});a.show()}onChatActivated(e){t(r.getState(),`tokens.${e}.token`)?ee.getNewMessagesCount(e):ee.getChatToken(e)}}class ne extends b{constructor(e){const t=ie("password_confirmation","password","Подтвердите пароль"),s=ie("password","password","Пароль"),n=ie("phone","text","Телефон"),i=ie("second_name","text","Фамилия"),a=ie("first_name","text","Имя"),o=ie("login","text","Логин"),r=ie("email","text","Email");super({classes:["base-form","sign-form","login-form"],actionContainer:new g({classes:["sign-in-form__action-container","sign-action-container"],link:e.link,btn:e.btn},"<div {{ classes link btn }}></div>"),email:r,login:o,firstName:a,secName:i,phone:n,pass:s,confirmPass:t,listeners:e.listeners},"<form {{ classes actionContainer confirmPass pass phone secName firstName login email }} >\n  </form>")}}function ie(e,t,s){let n;const i={name:e,type:t,placeholder:s,classes:["base-input","base-input-text","sign-text-input"],containerClasses:["sign-input-container"],labelClasses:["base-label"],validator:k.getValidator(e)};return n=new C(i),n}class ae extends d{constructor(){const e=new m({classes:["form-header"],textContent:"Регистрация"}),t=new d("a",{classes:["base-link","sign-link"],href:"/",textContent:"Войти"},"<a {{ classes textContent href }}></a>"),s=new v({type:"submit",value:"Авторизоваться",listeners:{click:function(){}},classes:["base-input","base-input-button","sign-btn","action-container__sign-up-btn"]}),n=new ne({link:t,btn:s});super("div",{mainBlock:new g({classes:["sign-in-block","main-block"],label:e,form:n})},"<div {{ classes mainBlock form }} ></div>"),t.setProps({listeners:this.getLinkListener()}),n.setProps({listeners:{submit:this.onSignUpSubmit.bind(this)}}),this.form=n,this.eventBus.on("signUpError",(e=>this.onSignUpError(e)))}getLinkListener(){return{click:e=>{e.preventDefault();new c("body").go("/")}}}onSignUpSubmit(e){e.preventDefault();const t=e.target,s={email:t.email.value,login:t.login.value,first_name:t.first_name.value,second_name:t.second_name.value,phone:t.phone.value,password:t.password.value};this.form.validate()||this.eventBus.emit("formSubmit",s)}onSignUpError(e){const t=new m({textContent:e}),s=new v({value:"OK",classes:["popup-btn","base-input-button","sign-btn"],listeners:{click:()=>{i.hide()}}}),n=new g({classes:["main-block","change-avatar-popup"],listeners:{click:e=>{e.cancelBubble=!0}},signUpErrorLabel:t,signUpErrorBtn:s},"<div {{ classes textContent loginErrorBtn loginErrorLabel }}></div>"),i=new y({popupContainer:n});i.show()}}const oe=new I("https://ya-praktikum.tech/api/v2/");const re=new class extends B{register(e){return oe.post("auth/signup",{credentials:"include",mode:"cors",headers:{"content-type":"application/json"},data:e}).then((e=>{200===e.status&&H.getUser()}))}};class ce extends l{constructor(){super(new ae),this.view.eventBus.on("formSubmit",(e=>this.onFormSubmit(e))),r.on(o.Updated,((e,t)=>this.onApplicationStoreUpdate(e,t)))}onFormSubmit(e){try{re.register(e)}catch(e){this.view.eventBus.emit("singUpError")}}onApplicationStoreUpdate(e,t){"user"===e&&t&&t.id&&this.onChangeUser(),"signUpError"===e&&this.view.eventBus.emit("signUpError",t)}onChangeUser(){new c("body").go("/messenger")}}class le extends d{constructor(e){const t=new g({classes:"error-number",textContent:e.errorNumber}),s=new g({classes:"error-text",textContent:e.errorText}),n=new d("a",{classes:["base-link","sign-link","error-link"],href:"/",textContent:"Назад к чатам"},"<a {{ classes textContent href }}></a>");super("div",{mainContainer:new g({classes:["main-container"],link:n,errorText:s,errorNumber:t},"<div {{ classes link errorText errorNumber }}></div>")},"<div {{ mainContainer }}></div>")}}class he extends le{constructor(){super({errorNumber:"404",errorText:"Не туда попали"})}}class ue extends l{constructor(){super(new he)}}H.getUser().then((()=>function(){const e=new c("body");e.use("/",V).use("/sign-up",ce).use("/settings",K).use("/messenger",se).use("/404",ue).start(),r.on(o.Updated,((t,s)=>{"user"!==t||s?.id||e.go("/")}))}())),r.on(o.Updated,(()=>console.dir(r.getState())));
//# sourceMappingURL=index.698ec532.js.map
